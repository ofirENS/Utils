<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T1U3">force</span> = MechanicalPointForce(<span class="var type1" id="S3T1U6">particlePosition</span>,<span class="var type1" id="S4T1U7">pointSourcePosition</span>, <span class="var type1" id="S5T2U8">forceDirection</span>, <span class="var type1" id="S6T2U9">forceMagnitude</span>,<span class="var type1" id="S7T2U10">cutoff</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">% apply mechanical (push or pull) force on particles</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">% mechanicalForce is a logical flag </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">% particlPosition is a N by 3 vector of particle position</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">% pointSourcePosition is the position of force sources </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">% forceDirection is either  -1 for 'in' or 1 for 'out'</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line"><span class="comment">% forceMagnitude is a positive number between 0 and 1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">% cutoff is the maximal direction the force operates on particle relative</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line"><span class="comment">% to the pointSourcePosition </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line"><span class="comment">% the output is a vector of N by 3 of delta position to th</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line"><span class="mxinfo " id="T1:U7"><span class="var type1" id="S8T1U13">forceTemp</span> = <span class="mxinfo " id="T1:U9">zeros(<span class="mxinfo " id="T24:U10">size(<span class="var type1" id="S3T1U18">particlePosition</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line"><span class="mxinfo " id="T1:U12"><span class="var type1" id="S2T1U21">force</span>     = <span class="mxinfo " id="T1:U14">zeros(<span class="mxinfo " id="T24:U15">size(<span class="var type1" id="S3T1U26">particlePosition</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line"><span class="mxinfo " id="T1:U17"><span class="var type1" id="S11T1U29">forceMag</span>  = <span class="mxinfo " id="T1:U19">zeros(<span class="mxinfo " id="T2:U20">size(<span class="var type1" id="S3T1U34">particlePosition</span>,1)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S12T2U38">sIdx</span> = <span class="mxinfo " id="T2:U23">1</span>:<span class="mxinfo " id="T2:U24">size(<span class="var type1" id="S4T1U43">pointSourcePosition</span>,1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line">        <span class="mxinfo " id="T1:U26"><span class="var type1" id="S13T1U47">forceDir</span> = <span class="mxinfo " id="T1:U28">bsxfun(@minus,<span class="var type1" id="S3T1U52">particlePosition</span>,<span class="mxinfo " id="T4:U30"><span class="var type1" id="S4T1U54">pointSourcePosition</span>(<span class="var type1" id="S12T2U55">sIdx</span>,<span class="mxinfo " id="T27:U33">:</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line">        <span class="keyword">if</span> strcmpi(<span class="var type1" id="S5T2U61">forceDirection</span>,<span class="string">'in'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line">            <span class="var type0" id="S13T0U65">forceDir</span> = -<span class="var type0" id="S13T0U67">forceDir</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line">        <span class="comment">% Find the distance between the particles and the source</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line">        <span class="mxinfo " id="T16:U35"><span class="var type1" id="S17T16U70">distToSource</span> = <span class="mxinfo " id="T16:U37">sqrt(<span class="mxinfo " id="T16:U38">sum(<span class="mxinfo " id="T1:U39"><span class="var type1" id="S13T1U76">forceDir</span>.^2</span>,2)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line">        <span class="comment">% Normalize the forceDirection</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S20T2U81">dIdx</span> = <span class="mxinfo " id="T2:U42">1</span>:3</span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line">          <span class="mxinfo " id="T16:U43"><span class="mxinfo " id="T16:U44"><span class="var type1" id="S13T1U88">forceDir</span>(<span class="mxinfo " id="T27:U46">:</span>,<span class="var type1" id="S20T2U90">dIdx</span>)</span> = <span class="mxinfo " id="T16:U48"><span class="mxinfo " id="T16:U49"><span class="var type1" id="S13T1U93">forceDir</span>(<span class="mxinfo " id="T27:U51">:</span>,<span class="var type1" id="S20T2U95">dIdx</span>)</span>./<span class="var type1" id="S17T16U96">distToSource</span></span></span>;<span class="comment">% bsxfun(@rdivide,forceDir,distToSource);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line">        <span class="comment">% Multiply the</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T7:U54"><span class="var type1" id="S5T2U100">forceDirection</span>==<span class="mxinfo " id="T2:U56">-<span class="mxinfo " id="T2:U57">1</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line">            <span class="mxinfo " id="T1:U58"><span class="var type1" id="S11T1U105">forceMag</span> = (<span class="mxinfo " id="T16:U60"><span class="mxinfo " id="T2:U61">1</span>-<span class="mxinfo " id="T16:U62"><span class="var type1" id="S6T2U110">forceMagnitude</span>./(<span class="mxinfo " id="T16:U64"><span class="mxinfo " id="T2:U65">1</span>+<span class="var type1" id="S17T16U114">distToSource</span></span>)</span></span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line">        <span class="keyword">elseif</span> <span class="mxinfo " id="T7:U67"><span class="var type1" id="S5T2U117">forceDirection</span>==<span class="mxinfo " id="T2:U69">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line">            <span class="mxinfo " id="T1:U70"><span class="var type1" id="S11T1U121">forceMag</span> = (<span class="mxinfo " id="T16:U72"><span class="var type1" id="S6T2U124">forceMagnitude</span>./(<span class="mxinfo " id="T16:U74"><span class="mxinfo " id="T2:U75">1</span>+<span class="var type1" id="S17T16U128">distToSource</span></span>)</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line">        <span class="keyword">for</span> <span class="var type1" id="S20T2U131">dIdx</span> = <span class="mxinfo " id="T2:U78">1</span>:3</span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line">            <span class="mxinfo " id="T16:U79"><span class="mxinfo " id="T16:U80"><span class="var type1" id="S8T1U138">forceTemp</span>(<span class="mxinfo " id="T27:U82">:</span>,<span class="var type1" id="S20T2U140">dIdx</span>)</span> = <span class="mxinfo " id="T16:U84"><span class="mxinfo " id="T16:U85"><span class="var type1" id="S13T1U143">forceDir</span>(<span class="mxinfo " id="T27:U87">:</span>,<span class="var type1" id="S20T2U145">dIdx</span>)</span>.*<span class="var type1" id="S11T1U146">forceMag</span></span></span>;<span class="comment">% bsxfun(@times,forceDir,forceTemp);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">40</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">41</a></span><span class="line">        <span class="mxinfo " id="T1:U90"><span class="mxinfo " id="T1:U91"><span class="var type1" id="S8T1U150">forceTemp</span>(<span class="mxinfo " id="T28:U93"><span class="var type1" id="S17T16U152">distToSource</span>&gt;<span class="var type1" id="S7T2U153">cutoff</span></span>,<span class="mxinfo " id="T27:U96">:</span>)</span> = <span class="mxinfo " id="T2:U97">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">42</a></span><span class="line">        <span class="mxinfo " id="T16:U98"><span class="mxinfo " id="T16:U99"><span class="var type1" id="S8T1U159">forceTemp</span>(<span class="mxinfo " id="T26:U101">isnan(<span class="var type1" id="S8T1U162">forceTemp</span>)</span>)</span>      = <span class="mxinfo " id="T2:U103">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43">43</a></span><span class="line">        <span class="mxinfo " id="T1:U104"><span class="var type1" id="S2T1U166">force</span>                            = <span class="mxinfo " id="T1:U106"><span class="var type1" id="S2T1U168">force</span>+<span class="var type1" id="S8T1U169">forceTemp</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44">44</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45">45</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
